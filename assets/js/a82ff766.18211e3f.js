"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[7928],{4720:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var t=o(2488),s=o(2780);const i={sidebar_position:1,id:"contracts"},r="Contracts Overview",c={id:"developers/contracts",title:"Contracts Overview",description:"This section is an overview of the system contracts that can be used in an Omni system. See below for greater details on method signatures and how to use them.",source:"@site/versioned_docs/version-0.1.0/developers/contracts.md",sourceDirName:"developers",slug:"/developers/contracts",permalink:"/docs/developers/contracts",draft:!1,unlisted:!1,editUrl:"https://github.com/omni-network/omni/docs/versioned_docs/version-0.1.0/developers/contracts.md",tags:[],version:"0.1.0",sidebarPosition:1,frontMatter:{sidebar_position:1,id:"contracts"},sidebar:"oldSidebar",previous:{title:"Rollup Settlement",permalink:"/docs/background/settlement"},next:{title:"Example Application",permalink:"/docs/developers/example"}},a={},l=[{value:"<code>OmniScient.sol</code>",id:"omniscientsol",level:2},{value:"<code>OmniPortal.sol</code>",id:"omniportalsol",level:2},{value:"How We Recommend Using the System Contracts",id:"how-we-recommend-using-the-system-contracts",level:2},{value:"On the Omni EVM",id:"on-the-omni-evm",level:3},{value:"Basics",id:"basics",level:4},{value:"Cross Rollup Transactions",id:"cross-rollup-transactions",level:4},{value:"Callbacks",id:"callbacks",level:4},{value:"On Rollups",id:"on-rollups",level:3},{value:"Sending Transactions",id:"sending-transactions",level:4},{value:"Verifying Omni Contract State",id:"verifying-omni-contract-state",level:4}];function d(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"contracts-overview",children:"Contracts Overview"}),"\n",(0,t.jsx)(n.p,{children:"This section is an overview of the system contracts that can be used in an Omni system. See below for greater details on method signatures and how to use them."}),"\n",(0,t.jsx)(n.h2,{id:"omniscientsol",children:(0,t.jsx)(n.code,{children:"OmniScient.sol"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Inherited by your global contracts on the Omni EVM."}),"\n",(0,t.jsxs)(n.li,{children:["Exposes methods to interact with the sources of transactions and send transactions to other rollups.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"omni.txSourceChain()"})," - the source of the current transaction."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"omni.sendTx(...)"})," - send a transaction to another rollup."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Exposes virtual methods that can be overwritten to receive callback functions upon success or failure of cross-rollup transactions. These methods are not required, but may be useful for richer expression of results in your smart contracts.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"function onXChainTxSuccess(...)"})," - called upon successful execution of a cross-rollup transaction."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"function onXChainTxReverted(...)"})," - called upon a reverted execution of a cross-rollup transaction."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"omniportalsol",children:(0,t.jsx)(n.code,{children:"OmniPortal.sol"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"An Omni system contract deployed to all integrated rollups."}),"\n",(0,t.jsxs)(n.li,{children:["Exposes methods to interact with the Omni EVM and other rollups.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"function sendOmniTx(...)"})," - send a transaction to Omni."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"function sendXChainTx(...)"})," - send a transaction to another rollup."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"function verifyOmniState(...)"})," - verify the state of a smart contract on Omni."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"how-we-recommend-using-the-system-contracts",children:"How We Recommend Using the System Contracts"}),"\n",(0,t.jsx)(n.h3,{id:"on-the-omni-evm",children:"On the Omni EVM"}),"\n",(0,t.jsx)(n.h4,{id:"basics",children:"Basics"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["You should store your application\u2019s global logic within Omni\u2019s EVM. To interact with interoperability primitives, import the ",(0,t.jsx)(n.code,{children:"OmniScient.sol"})," contract and extend its class in your contracts."]}),"\n",(0,t.jsxs)(n.li,{children:["You may want some functions to only be called through the Omni EVM, and some to only be called from other rollups. For this, check the ",(0,t.jsx)(n.code,{children:"omni.txSourceChain()"}),".","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["For a contract you only want to be executed from omni, ensure: ",(0,t.jsx)(n.code,{children:"require(omni.isOmniTx())"})]}),"\n",(0,t.jsxs)(n.li,{children:["For a contract you only want to be executed from other rollups, ensure: ",(0,t.jsx)(n.code,{children:"require(omni.isExternalTx())"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["You can also require that some functions are only called from specific domains. For example, you could use:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:'require(isTxFrom("arbitrum-goerli"))\n\n// OR\n\nrequire(isTxFromOneOf("arbitrum-goerli", "optimism-goerli"))\n// this is an overloaded function, you can provide up to 5 arguments\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["You\u2019ll likely want to track where transactions are coming from in your global state. You can use ",(0,t.jsx)(n.code,{children:"omni.txSourceChain()"})," in a mapping or other data structures."]}),"\n",(0,t.jsx)(n.h4,{id:"cross-rollup-transactions",children:"Cross Rollup Transactions"}),"\n",(0,t.jsx)(n.p,{children:"To send a transaction to another rollup, use:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"omni.sendTx(\n    string memory _chain,  // rollup identifier, ex 'optimism-goerli'\n    address _to,           // contract address on the dest rollup to execute the call on\n    bytes memory _data     // calldata for the transaction, abi encoded, 10kb limit\n)\n"})}),"\n",(0,t.jsx)(n.h4,{id:"callbacks",children:"Callbacks"}),"\n",(0,t.jsxs)(n.p,{children:["When you use the ",(0,t.jsx)(n.code,{children:"omni.sendTx(...)"})," method to send a cross rollup transaction, you can opt to receive a callback function based on the successful or unsuccessful execution of that transaction on the destination chain. You can override these virtual functions with your own logic."]}),"\n",(0,t.jsxs)(n.p,{children:["When you override these functions, make sure to keep the ",(0,t.jsx)(n.code,{children:"onlyOmni"})," modifier in your logic. This will ensure that only the Omni system can execute these callback functions."]}),"\n",(0,t.jsx)(n.p,{children:"The method signatures are:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"function onXChainTxSuccess(\n    OmniCodec.Tx memory _xtx,\n    address _sender,\n    bytes memory _returnValue,\n    uint256 _gasSpent\n) virtual external onlyOmni {}\n\nfunction onXChainTxReverted(\n    OmniCodec.Tx memory _xtx,\n    address _sender,\n    uint256 _gasSpent\n) virtual external onlyOmni {}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If you\u2019d like to use these callbacks, you should import OmniCodec library because the first argument is ",(0,t.jsx)(n.code,{children:"OmniCodec.Tx"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"struct Tx {\n    bytes32 sourceTxHash;\n    string sourceChain;\n    string destChain;\n    uint64 nonce;\n    address from;\n    address to;\n    uint256 value;\n    uint256 paid;\n    uint64 gasLimit;\n    bytes data;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"and you can use these values however you'd like."}),"\n",(0,t.jsx)(n.h3,{id:"on-rollups",children:"On Rollups"}),"\n",(0,t.jsx)(n.h4,{id:"sending-transactions",children:"Sending Transactions"}),"\n",(0,t.jsxs)(n.p,{children:["To send transactions ",(0,t.jsx)(n.em,{children:"from"})," another rollup, your smart contracts on those rollups must interact with an ",(0,t.jsx)(n.code,{children:"OmniPortal"})," contract, a singleton contract deployed on each rollup. Check the docs for relevant addresses."]}),"\n",(0,t.jsx)(n.p,{children:"You can either execute a transaction on Omni, or on another rollup. We recommend sending a transaction to Omni if you\u2019d like to update global state, and sending a transaction directly to other rollups for other function types that don\u2019t require global state updates."}),"\n",(0,t.jsx)(n.p,{children:"To send a transaction to Omni, use:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"function sendOmniTx(\n    address _to,\n    bytes memory _data\n) public;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["To send transactions from another rollup, your smart contracts on those rollups must interact with an ",(0,t.jsx)(n.code,{children:"OmniPortal"})," contract, a singleton contract deployed on each rollup. Check the docs for relevant addresses."]}),"\n",(0,t.jsx)(n.p,{children:"You can either execute a transaction on Omni, or on another rollup. We recommend sending a transaction to Omni if you\u2019d like to update global state, and sending a transaction directly to other rollups for other function types that don\u2019t require global state updates."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"function sendOmniTx(\n    address _to,\n    bytes memory _data\n) public;\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"function sendXChainTx(\n    string memory _chain,\n    address _to,\n    bytes memory _data\n) public;\n"})}),"\n",(0,t.jsx)(n.h4,{id:"verifying-omni-contract-state",children:"Verifying Omni Contract State"}),"\n",(0,t.jsx)(n.p,{children:"From each rollup, you can also check the state of your global contracts on Omni. For example, you may want to check the value of some state variable in your Omni EVM contract, and then execute certain logic based on that value."}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"This functionality only works on rollups with the sha256 opcode enabled (Scroll does not currently support this opcode)."})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-solidity",children:"function verifyOmniState(\n        uint64 _blockNumber,\n        bytes memory _storageProof,\n        bytes memory _storageKey,\n        bytes memory _storageValue\n) public view returns (bool)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The block number is the block you\u2019re interested in checking the state against. The ",(0,t.jsx)(n.code,{children:"_storageProof"})," can be queried from an Omni RPC with the ",(0,t.jsx)(n.code,{children:"eth_getProof"})," method, and the ",(0,t.jsx)(n.code,{children:"_storageKey"}),", and ",(0,t.jsx)(n.code,{children:"_storageValue"})," inputs are based on your implemented contracts."]})]})}function h(e={}){const{wrapper:n}={...(0,s.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},2780:(e,n,o)=>{o.d(n,{I:()=>c,M:()=>r});var t=o(6651);const s={},i=t.createContext(s);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);